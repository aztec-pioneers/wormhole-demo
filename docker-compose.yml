services:
  # VAA Verification Service - Aztec Wormhole VAA verifier
  vaa-service:
    build:
      context: .
      dockerfile: packages/aztec-vaa-service/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      # Aztec devnet configuration
      - AZTEC_NODE_URL=${AZTEC_NODE_URL}
      - ROLLUP_VERSION=${ROLLUP_VERSION}
      # Relayer account credentials
      - AZTEC_RELAYER_PRIVATE_KEY=${AZTEC_RELAYER_PRIVATE_KEY}
      - AZTEC_RELAYER_SALT=${AZTEC_RELAYER_SALT}
      # Wormhole contract on Aztec
      - AZTEC_WORMHOLE_ADDRESS=${AZTEC_WORMHOLE_ADDRESS}
      # Bridge contract on Aztec
      - AZTEC_BRIDGE_ADDRESS=${AZTEC_BRIDGE_ADDRESS}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    networks:
      - relayer-network

  # Wormhole Spy - monitors guardian network for VAAs
  wormhole-spy:
    image: ghcr.io/wormhole-foundation/guardiand:latest
    platform: linux/amd64
    entrypoint: /guardiand
    command:
      - spy
      - --nodeKey
      - /node.key
      - --spyRPC
      - "[::]:7073"
      - --env
      - testnet
      - --logLevel
      - error
    ports:
      - "7073:7073"
    networks:
      - relayer-network
    restart: unless-stopped


  # Relayer for Arbitrum EVM destination (listens for Aztec + Solana + Base VAAs)
  relayer-arbitrum:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command:
      - evm
      - --chain=arbitrum
      - --private-key=${EVM_PRIVATE_KEY}
      - --evm-target-contract=${ARBITRUM_BRIDGE_ADDRESS}
    environment:
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      - WORMHOLE_RELAYER_EVM_RPC_URL=${ARBITRUM_RPC_URL}
    depends_on:
      - wormhole-spy
    networks:
      - relayer-network
    restart: unless-stopped

  # Relayer for Base EVM destination (listens for Aztec + Solana + Arbitrum VAAs)
  relayer-base:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command:
      - evm
      - --chain=base
      - --private-key=${EVM_PRIVATE_KEY}
      - --evm-target-contract=${BASE_BRIDGE_ADDRESS}
    environment:
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      - WORMHOLE_RELAYER_EVM_RPC_URL=${BASE_RPC_URL}
    depends_on:
      - wormhole-spy
    networks:
      - relayer-network
    restart: unless-stopped

  # Relayer for Aztec destination (listens for Arbitrum + Solana + Base VAAs)
  relayer-aztec:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command:
      - aztec
      - --aztec-target-contract=${AZTEC_BRIDGE_ADDRESS}
      # Default: --chain-ids=10003,1,10004 (Arbitrum, Solana, Base)
    environment:
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      - WORMHOLE_RELAYER_VERIFICATION_SERVICE_URL=http://vaa-service:3000
    depends_on:
      wormhole-spy:
        condition: service_started
      vaa-service:
        condition: service_healthy
    networks:
      - relayer-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # Solana VAA Posting Service - posts VAAs to Wormhole on Solana
  solana-vaa-service:
    build:
      context: ./packages/solana-vaa-service
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - SOLANA_RPC_URL=${SOLANA_RPC_URL}
      - SOLANA_PRIVATE_KEY=${SOLANA_PRIVATE_KEY}
      - SOLANA_WORMHOLE_PROGRAM_ID=${SOLANA_WORMHOLE_PROGRAM_ID}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - relayer-network

  # Relayer for Solana destination (listens for Arbitrum + Aztec + Base VAAs)
  relayer-solana:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command:
      - solana
      - --solana-private-key=${SOLANA_PRIVATE_KEY}
      - --solana-program-id=${SOLANA_BRIDGE_PROGRAM_ID}
      # Default: --chain-ids=10003,56,10004 (Arbitrum, Aztec, Base)
    environment:
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      - WORMHOLE_RELAYER_SOLANA_RPC_URL=${SOLANA_RPC_URL}
      - WORMHOLE_RELAYER_SOLANA_WORMHOLE_PROGRAM_ID=${SOLANA_WORMHOLE_PROGRAM_ID}
      - WORMHOLE_RELAYER_SOLANA_VAA_SERVICE_URL=http://solana-vaa-service:3001
    depends_on:
      wormhole-spy:
        condition: service_started
      solana-vaa-service:
        condition: service_healthy
    networks:
      - relayer-network
    restart: unless-stopped

networks:
  relayer-network:
    driver: bridge
