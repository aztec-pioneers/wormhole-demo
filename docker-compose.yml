services:
  # VAA Verification Service - Aztec Wormhole VAA verifier
  vaa-service:
    build:
      context: .
      dockerfile: packages/aztec-vaa-service/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      # Aztec devnet configuration
      - AZTEC_NODE_URL=${AZTEC_NODE_URL}
      - ROLLUP_VERSION=${ROLLUP_VERSION}
      # Relayer account credentials
      - AZTEC_RELAYER_PRIVATE_KEY=${AZTEC_RELAYER_PRIVATE_KEY}
      - AZTEC_RELAYER_SALT=${AZTEC_RELAYER_SALT}
      # Wormhole contract on Aztec
      - AZTEC_WORMHOLE_ADDRESS=${AZTEC_WORMHOLE_ADDRESS}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    networks:
      - relayer-network

  # Wormhole Spy - monitors guardian network for VAAs
  wormhole-spy:
    image: ghcr.io/wormhole-foundation/guardiand:latest
    platform: linux/amd64
    entrypoint: /guardiand
    command:
      - spy
      - --nodeKey
      - /node.key
      - --spyRPC
      - "[::]:7073"
      - --env
      - testnet
      - --logLevel
      - error
    ports:
      - "7073:7073"
    networks:
      - relayer-network
    restart: unless-stopped


  # Relayer for Aztec -> EVM (listens for Aztec VAAs, submits to EVM)
  relayer-to-evm:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command:
      - evm
      - --private-key=${EVM_PRIVATE_KEY}
      - --evm-target-contract=${EVM_BRIDGE_ADDRESS}
    environment:
      # Wormhole Spy (prefixed for viper)
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      # EVM RPC URL
      - WORMHOLE_RELAYER_EVM_RPC_URL=${ARBITRUM_RPC_URL}
    depends_on:
      - wormhole-spy
    networks:
      - relayer-network
    restart: unless-stopped


  # Relayer for EVM -> Aztec (listens for EVM VAAs, submits to Aztec VAA service)
  relayer-to-aztec:
    build:
      context: ./packages/relayer
      dockerfile: Dockerfile
    command: ["aztec"]
    environment:
      # Wormhole Spy (prefixed for viper)
      - WORMHOLE_RELAYER_SPY_RPC_HOST=wormhole-spy:7073
      # Source chain (EVM - Arbitrum Sepolia)
      - WORMHOLE_RELAYER_CHAIN_ID=${WORMHOLE_CHAIN_ID:-10003}
      # VAA verification service
      - WORMHOLE_RELAYER_VERIFICATION_SERVICE_URL=http://vaa-service:3000
    depends_on:
      wormhole-spy:
        condition: service_started
      vaa-service:
        condition: service_healthy
    networks:
      - relayer-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

networks:
  relayer-network:
    driver: bridge
